<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <uses-permission android:name="android.permission.INTERNET" />
    <title>AllesNL Custom Mini-App</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Roboto', 'Segoe UI', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 0; margin: 0; overflow-x: hidden; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        .container { background: white; min-height: 100vh; width: 100%; padding: 20px 16px; animation: fadeIn 0.4s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        header { text-align: center; margin-bottom: 24px; padding-top: 8px; }
        h1 { color: #667eea; font-size: 1.75em; margin-bottom: 8px; font-weight: 700; }
        .subtitle { color: #666; font-size: 1em; }
        .content-section { margin: 16px 0; }
        .card { background: #f8f9fa; border-radius: 12px; padding: 20px 16px; margin: 16px 0; transition: transform 0.2s ease; touch-action: manipulation; }
        .card:active { transform: scale(0.98); }
        .card h3 { color: #764ba2; margin-bottom: 12px; font-size: 1.2em; font-weight: 600; }
        .card p { color: #555; line-height: 1.6; font-size: 0.95em; }
        .button-group { display: flex; flex-direction: column; gap: 12px; margin-top: 24px; padding: 0 4px; }
        .btn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 16px 24px; border-radius: 12px; font-size: 1em; font-weight: 600; cursor: pointer; transition: all 0.2s ease; text-decoration: none; display: block; text-align: center; width: 100%; touch-action: manipulation; -webkit-user-select: none; user-select: none; min-height: 48px; }
        .btn:active { transform: scale(0.96); opacity: 0.9; }
        .btn-secondary { background: white; color: #667eea; border: 2px solid #667eea; }
        .btn-secondary:active { background: #f0f0f0; }
        footer { text-align: center; margin-top: 32px; padding: 20px 0 24px 0; border-top: 1px solid #ddd; color: #888; font-size: 0.85em; }
        .feature-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin: 16px 0; }
        .feature-item { text-align: center; padding: 16px 8px; background: white; border-radius: 10px; }
        .feature-icon { font-size: 2em; margin-bottom: 8px; }
        .feature-item strong { font-size: 0.85em; display: block; color: #333; }
        @supports (padding: max(0px)) { .container { padding-left: max(16px, env(safe-area-inset-left)); padding-right: max(16px, env(safe-area-inset-right)); padding-bottom: max(20px, env(safe-area-inset-bottom)); } }
        .btn, .card h3, .feature-item { -webkit-touch-callout: none; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; }
        html { scroll-behavior: smooth; }
        .status-chip { display: inline-flex; align-items: center; gap: 8px; border-radius: 999px; padding: 8px 12px; font-weight: 600; }
        .status-true { background: #e8fff3; color: #0a7c44; border: 1px solid #bdf0d3; }
        .status-false { background: #fff1f0; color: #b42318; border: 1px solid #ffcdc7; }
        .muted { color: #666; font-size: .9rem; }
        input[type="text"], textarea { width: 100%; padding: 14px 12px; border: 1px solid #dfe3ea; border-radius: 10px; font-size: 1rem; outline: none; }
        input[type="text"]:focus, textarea:focus { border-color: #667eea; }
        .row { display: grid; gap: 12px; }
        @media (min-width: 560px) { .row { grid-template-columns: 1fr auto; align-items: end; } }
    </style>
</head>
<body>
<div class="container">
    <header>
        <h1>Transportation App</h1>
        <p class="subtitle">Buy a train ticket between two Dutch cities</p>
    </header>

    <section class="card">
        <h3>Select Your Trip</h3>
        <div class="content-section">
            <div class="row" style="grid-template-columns: 1fr 1fr; gap: 12px;">
                <div>
                    <label for="origin-select">Origin</label>
                    <select id="origin-select" aria-label="Origin city">
                        <option value="" disabled selected>Select origin</option>
                    </select>
                </div>
                <div>
                    <label for="destination-select">Destination</label>
                    <select id="destination-select" aria-label="Destination city">
                        <option value="" disabled selected>Select destination</option>
                    </select>
                </div>
            </div>

            <div class="button-group" style="margin-top:16px;">
                <button id="get-ticket-btn" class="btn">Get Ticket</button>
            </div>

            <div style="margin-top:16px;">
                <span id="response-status" class="status-chip muted">Waiting for input </span>
            </div>
        </div>
    </section>

    <footer>Made with <3 for AllesNL mini-apps</footer>
</div>

<script>
    (function initTicketUI() {
        const cities = [
            'Amsterdam','Rotterdam','Den Haag','Utrecht','Eindhoven','Tilburg','Groningen',
            'Almere','Breda','Nijmegen','Enschede','Apeldoorn','Haarlem','Amersfoort',
            'Arnhem','Zaanstad','Haarlemmermeer','\'s-Hertogenbosch','Zwolle','Leiden',
            'Maastricht','Dordrecht','Delft','Leeuwarden','Heerlen','Helmond'
        ];

        const originSel = document.getElementById('origin-select');
        const destSel   = document.getElementById('destination-select');
        const btn       = document.getElementById('get-ticket-btn');

        function fillSelect(selectEl) {
            cities.forEach(city => {
                const opt = document.createElement('option');
                opt.value = city;
                opt.textContent = city;
                selectEl.appendChild(opt);
            });
        }

        fillSelect(originSel);
        fillSelect(destSel);

        btn.addEventListener('click', function() {
            const origin = originSel.value;
            const destination = destSel.value;

            if (!origin || !destination) {
                updateStatus('Please select both origin and destination.', true);
                return;
            }
            if (origin === destination) {
                updateStatus('Origin and destination must be different.', true);
                return;
            }

            // Inform user locally
            updateStatus(`Requesting ticket: ${origin} → ${destination}…`, false);

            // Call the provided sendCommand without modifying its implementation
            sendCommand(
                HttpMethods.POST,
                'ticket',
                { origin: origin, destination: destination }
            );
        });
    })();
</script>

<script>
    // Do not change the signature but feel free to change the body
    // Single entry point: ALL status updates & backend payload handling happen here
    // updateStatus(message, isError)
    // - message can be plain text OR a JSON string/object like { message: true|false }
    // - isError is a boolean indicating generic error state when not sending a backend payload
    function updateStatus(body, isError) {
        const el = document.getElementById('response-status');
        el.classList.remove('status-true', 'status-false', 'muted');

        // Normalize body into an object if it's a string
        let obj = body;
        if (typeof body === 'string') {
            try { obj = JSON.parse(body); } catch (_) { obj = body; }
        }

        // Clear any existing ticket cards
        const oldCard = document.getElementById('ticket-card');
        if (oldCard) oldCard.remove();

        if (obj && typeof obj === 'object') {
            // Handle backend JSON structure
            const success = obj.success === true;
            const message = obj.message || 'Response received';
            el.textContent = message;
            el.classList.add(success ? 'status-true' : 'status-false');

            // If we got a successful ticket creation, show the ticket card
            if (success && obj.data && obj.data.origin && obj.data.destination && obj.data.time) {
                const ticket = obj.data;

                // Create a card container
                const card = document.createElement('div');
                card.id = 'ticket-card';
                card.className = 'card';
                card.style.marginTop = '16px';
                card.innerHTML = `
                <h3> Your Ticket</h3>
                <p><strong>From:</strong> ${ticket.origin}</p>
                <p><strong>To:</strong> ${ticket.destination}</p>
                <p><strong>Departure Time:</strong> ${ticket.time}</p>
            `;

                // Insert it below the response-status element
                el.insertAdjacentElement('afterend', card);
            }
            return;
        }

        // Fallback for plain text
        el.textContent = String(body);
        el.classList.add(isError ? 'status-false' : 'muted');
    }
</script>
<script>
    /////////////////////////
    ///// DO NOT CHANGE  ////
    /////////////////////////
    const HttpMethods = Object.freeze({
        POST: 'POST',
        GET: 'GET',
        DELETE: 'DELETE'
    });

    // Generic function for other commands
    function sendCommand(method, dataType, body, sendUserData = false) {
        const command = {
            method: method,
            headers: {
                'Data-Type': dataType
            },
            body: body,
            sendUserData: sendUserData
        };
        const jsonString = JSON.stringify(command);

        if (window.Bridge) {
            window.Bridge.postMessage(jsonString);
        } else {
            console.error('JavaScript Channel "Bridge" not found.');
            updateStatus('Error: JavaScript Bridge not found.', true);
        }
    }

    // Special case function specifically for making a POST payment
    function makePayment(amount) {
        const command = {
            method: 'POST',
            headers: {
                'Data-Type': 'payment'
            },
            body: {
                'amount': amount
            }
        };

        const jsonString = JSON.stringify(command);

        if (window.Bridge) {
            window.Bridge.postMessage(jsonString);
        } else {
            console.error('JavaScript Channel "Bridge" not found.');
            updateStatus('Error: JavaScript Bridge not found.', true);
        }
    }
</script>